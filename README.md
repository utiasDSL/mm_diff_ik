# Mobile Manipulator Code

Redundancy resolution for the Thing mobile manipulator via optimization to
solve the IK problem.

## Packages

### mm_motion_control

Inner-loop motion controller that implements proportional control with velocity
feedforward in task space, followed by an optimization over the joint
velocities to send to the robot. Written in C++. Optimizer is
[qpOASES](https://projects.coin-or.org/qpOASES).

#### Subscribers
* `/trajectory/point` (`geometry_msgs/PoseStamped`): Takes a single pose in
  task space to control toward at a specified future time.
* `/trajectory/poses` (`mm_msgs/PoseTrajectory`): Takes a trajectory of poses
  in task space to track.
* `/mm_joint_states` (`sensor_msgs/JointState`): Takes position and velocity
  of the joints of the Thing.
  (`ur_modern_driver`).
* `/obstacles` (`mm_msgs/Obstacles`): Contains all detected obstacles.
* `/force_control/position_offset` (`geometry_msgs/Vector3Stamped`): Position
  offset generated by force controller.

#### Publishers
* `/ur_driver/joint_speed` (`trajectory_msgs/JointTrajectory`): Publishes joint
  speed commands to the UR10. Only the first point is parsed, and then only the
  velocities (and possibly accelerations---not sure about this)
* `/ridgeback_velocity_controller/cmd_vel` (`geometry_msgs/Twist`): Publishes
  joint speed commands to the Ridgeback base.
* `/mm_pose_state` (`mm_msgs/PoseControlState`): Information about the actual,
  desired, and error pose of the EE.

### mm_force_control

Outer-loop force controller, also responsible for trajectory generation. Runs
at ~10Hz. Written in Python.

### mm_simulation

Basic simulation of the Thing kinematics in Python for visualization. Should
eventually be replaced by a proper Gazebo simulation.

### mm_msgs

Defines custom ROS messages used by other packages in the project.

### mm_vicon

Contains Vicon estimation code and launch files for the Vicon system. To
publish the Thing base pose from Vicon, connect to the Vicon wifi
`DSL_DroneNet_5G` (see the wiki for the password) and run `roslaunch mm_vicon
vicon.launch`. You should see the topic `/vicon/ThingBase/ThingBase` bring
published.

### mm_kinematics

Contains forward kinematics code in both C++ and Python for use by other
packages.

## Build
```bash
# normal build
catkin build

# with compiler optimizations
catkin build -DCMAKE_BUILD_TYPE=Release
```

## Run
### Simulation
```bash
> roslaunch mm_motion_control mm_motion_control_sim.launch
> roslaunch mm_simulation sim.launch
> rosrun mm_trajectories launch_traj.py
```

### Experiment
1. Connect to `DSL_DroneNet_5G` network.
2. Connect to the Thing via Ethernet.
3. Ensure ROS is configured to use the Thing as master:
```bash
# on laptop
> export ROS_IP=192.168.131.100
> export ROS_MASTER_URI=http://cpr-tor11-01:11311
```
If you run `rostopic list`, you should see various topics related to the Thing
listed.
4. Run:
```bash
# on laptop
> roslaunch mm_vicon vicon.launch

# on board
> roslaunch mm_motion_control mm_motion_control.launch

# on laptop, if using force control
> rosrun mm_force_control force.py

# on laptop
> rosrun mm_trajectories line.py
```

Other useful commands (run on the laptop) include:
```bash
# go to home position defined in mm_motion_control/joint_control/manager.h
> roslaunch mm_motion_control home.launch
```
